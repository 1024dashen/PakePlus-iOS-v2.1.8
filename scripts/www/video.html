<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>摄像头视频录制</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
                color: #333;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
                background: white;
                border-radius: 20px;
                padding: 30px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            }

            header {
                text-align: center;
                margin-bottom: 30px;
                padding-bottom: 20px;
                border-bottom: 2px solid #f0f0f0;
            }

            h1 {
                color: #4a5568;
                margin-bottom: 10px;
            }

            .subtitle {
                color: #718096;
                font-size: 1.1em;
            }

            .main-content {
                display: flex;
                flex-wrap: wrap;
                gap: 30px;
                margin-bottom: 30px;
            }

            .video-section {
                flex: 1;
                min-width: 300px;
            }

            .controls-section {
                flex: 1;
                min-width: 300px;
            }

            .video-container {
                position: relative;
                width: 100%;
                background: #000;
                border-radius: 10px;
                overflow: hidden;
                margin-bottom: 20px;
            }

            video {
                width: 100%;
                height: auto;
                display: block;
                background: #000;
            }

            .placeholder {
                width: 100%;
                height: 400px;
                background: linear-gradient(
                    45deg,
                    #2d3748 25%,
                    #4a5568 25%,
                    #4a5568 50%,
                    #2d3748 50%,
                    #2d3748 75%,
                    #4a5568 75%
                );
                background-size: 60px 60px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 18px;
            }

            .controls {
                background: #f8f9fa;
                padding: 25px;
                border-radius: 15px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }

            .device-selector {
                margin-bottom: 25px;
            }

            label {
                display: block;
                margin-bottom: 8px;
                color: #4a5568;
                font-weight: 600;
            }

            select,
            input {
                width: 100%;
                padding: 12px 15px;
                border: 2px solid #e2e8f0;
                border-radius: 8px;
                font-size: 16px;
                transition: all 0.3s;
                background: white;
            }

            select:focus,
            input:focus {
                outline: none;
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }

            .video-controls {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 15px;
                margin-bottom: 25px;
            }

            .btn {
                padding: 14px 20px;
                border: none;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
            }

            .btn i {
                font-size: 18px;
            }

            .btn-primary {
                background: #667eea;
                color: white;
            }

            .btn-primary:hover {
                background: #5a67d8;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            }

            .btn-primary:disabled {
                background: #cbd5e0;
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
            }

            .btn-secondary {
                background: #48bb78;
                color: white;
            }

            .btn-secondary:hover:not(:disabled) {
                background: #38a169;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
            }

            .btn-danger {
                background: #f56565;
                color: white;
            }

            .btn-danger:hover:not(:disabled) {
                background: #e53e3e;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(245, 101, 101, 0.4);
            }

            .btn-warning {
                background: #ed8936;
                color: white;
            }

            .btn-warning:hover:not(:disabled) {
                background: #dd6b20;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(237, 137, 54, 0.4);
            }

            .btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                transform: none !important;
                box-shadow: none !important;
            }

            .status {
                padding: 15px;
                border-radius: 8px;
                margin-top: 20px;
                font-weight: 600;
                text-align: center;
            }

            .status.recording {
                background: #fed7d7;
                color: #c53030;
                animation: pulse 2s infinite;
            }

            .status.ready {
                background: #c6f6d5;
                color: #276749;
            }

            .status.idle {
                background: #e2e8f0;
                color: #4a5568;
            }

            @keyframes pulse {
                0% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.7;
                }
                100% {
                    opacity: 1;
                }
            }

            .recordings {
                margin-top: 30px;
            }

            .recordings h3 {
                margin-bottom: 15px;
                color: #4a5568;
            }

            .recordings-list {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 15px;
            }

            .recording-item {
                background: #f8f9fa;
                padding: 15px;
                border-radius: 10px;
                border: 2px solid #e2e8f0;
            }

            .recording-item video {
                width: 100%;
                border-radius: 5px;
                margin-bottom: 10px;
            }

            .recording-info {
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 14px;
                color: #718096;
            }

            .recording-actions {
                display: flex;
                gap: 8px;
                margin-top: 10px;
            }

            .recording-actions .btn {
                padding: 8px 12px;
                font-size: 14px;
            }

            @media (max-width: 768px) {
                .main-content {
                    flex-direction: column;
                }

                .video-controls {
                    grid-template-columns: 1fr;
                }
            }
        </style>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        />
    </head>
    <body>
        <div class="container">
            <header>
                <h1><i class="fas fa-video"></i> 摄像头视频录制系统</h1>
                <p class="subtitle">
                    访问摄像头并录制视频 | 支持多设备切换和视频回放
                </p>
            </header>

            <div class="main-content">
                <div class="video-section">
                    <div class="video-container">
                        <video id="liveVideo" autoplay playsinline></video>
                        <div id="videoPlaceholder" class="placeholder">
                            <div>
                                <i
                                    class="fas fa-video-slash fa-3x"
                                    style="margin-bottom: 15px"
                                ></i>
                                <p>摄像头未启动</p>
                                <p style="font-size: 14px; margin-top: 10px">
                                    点击"开启摄像头"按钮开始
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="controls">
                        <div class="device-selector">
                            <label for="cameraSelect"
                                ><i class="fas fa-camera"></i> 选择摄像头</label
                            >
                            <select id="cameraSelect">
                                <option value="">加载摄像头设备中...</option>
                            </select>
                        </div>

                        <div class="video-controls">
                            <button id="startCamera" class="btn btn-primary">
                                <i class="fas fa-play"></i> 开启摄像头
                            </button>
                            <button
                                id="stopCamera"
                                class="btn btn-danger"
                                disabled
                            >
                                <i class="fas fa-stop"></i> 关闭摄像头
                            </button>
                            <button
                                id="startRecording"
                                class="btn btn-secondary"
                                disabled
                            >
                                <i class="fas fa-circle"></i> 开始录制
                            </button>
                            <button
                                id="stopRecording"
                                class="btn btn-warning"
                                disabled
                            >
                                <i class="fas fa-square"></i> 停止录制
                            </button>
                            <button
                                id="takeSnapshot"
                                class="btn"
                                disabled
                                style="background: #805ad5; color: white"
                            >
                                <i class="fas fa-camera-retro"></i> 拍照
                            </button>
                        </div>

                        <div class="quality-settings">
                            <label
                                ><i class="fas fa-sliders-h"></i>
                                视频质量设置</label
                            >
                            <div
                                style="
                                    display: flex;
                                    gap: 15px;
                                    margin-top: 10px;
                                "
                            >
                                <select
                                    id="resolutionSelect"
                                    title="resolutionSelect"
                                    style="flex: 1"
                                >
                                    <option value="default">默认分辨率</option>
                                    <option value="hd">高清 (720p)</option>
                                    <option value="full-hd">
                                        全高清 (1080p)
                                    </option>
                                    <option value="4k">
                                        4K (需要设备支持)
                                    </option>
                                </select>
                                <select
                                    id="frameRateSelect"
                                    title="frameRateSelect"
                                    style="flex: 1"
                                >
                                    <option value="default">默认帧率</option>
                                    <option value="30">30 FPS</option>
                                    <option value="60">60 FPS</option>
                                </select>
                            </div>
                        </div>

                        <div id="status" class="status idle">
                            <i class="fas fa-info-circle"></i> 就绪 -
                            点击"开启摄像头"按钮开始
                        </div>
                    </div>
                </div>

                <div class="recordings-section">
                    <div class="recordings">
                        <h3><i class="fas fa-film"></i> 录制列表</h3>
                        <div id="recordingsList" class="recordings-list">
                            <div
                                class="recording-item"
                                style="text-align: center; padding: 30px"
                            >
                                <i
                                    class="fas fa-video fa-2x"
                                    style="color: #cbd5e0; margin-bottom: 10px"
                                ></i>
                                <p>录制视频将显示在这里</p>
                            </div>
                        </div>
                    </div>

                    <div
                        style="
                            margin-top: 30px;
                            padding: 20px;
                            background: #f8f9fa;
                            border-radius: 10px;
                        "
                    >
                        <h4><i class="fas fa-lightbulb"></i> 使用说明</h4>
                        <ol
                            style="
                                margin-top: 10px;
                                padding-left: 20px;
                                line-height: 1.6;
                            "
                        >
                            <li>
                                点击<strong>"开启摄像头"</strong>按钮访问摄像头
                            </li>
                            <li>选择不同的摄像头设备（如果有多摄像头）</li>
                            <li>点击<strong>"开始录制"</strong>按钮录制视频</li>
                            <li>点击<strong>"停止录制"</strong>按钮完成录制</li>
                            <li>录制完成后可以在下方回放视频</li>
                            <li>
                                点击<strong>"拍照"</strong>按钮可以截取当前画面
                            </li>
                        </ol>
                    </div>
                </div>
            </div>

            <footer
                style="
                    text-align: center;
                    margin-top: 30px;
                    padding-top: 20px;
                    border-top: 1px solid #e2e8f0;
                    color: #718096;
                "
            >
                <p>
                    基于 WebRTC 技术 | 兼容 Chrome, Firefox, Edge, Safari
                    等现代浏览器
                </p>
                <p style="font-size: 0.9em; margin-top: 5px">
                    注意：需要在 HTTPS 环境下运行 (localhost 除外)
                </p>
            </footer>
        </div>

        <script>
            // DOM 元素
            const liveVideo = document.getElementById('liveVideo')
            const videoPlaceholder = document.getElementById('videoPlaceholder')
            const cameraSelect = document.getElementById('cameraSelect')
            const resolutionSelect = document.getElementById('resolutionSelect')
            const frameRateSelect = document.getElementById('frameRateSelect')
            const recordingsList = document.getElementById('recordingsList')

            // 按钮元素
            const startCameraBtn = document.getElementById('startCamera')
            const stopCameraBtn = document.getElementById('stopCamera')
            const startRecordingBtn = document.getElementById('startRecording')
            const stopRecordingBtn = document.getElementById('stopRecording')
            const takeSnapshotBtn = document.getElementById('takeSnapshot')
            const statusDiv = document.getElementById('status')

            // 全局变量
            let mediaStream = null
            let mediaRecorder = null
            let recordedChunks = []
            let devices = []

            // 更新状态显示
            function updateStatus(message, type = 'idle') {
                statusDiv.textContent = message
                statusDiv.className = `status ${type}`

                // 添加图标
                const icon =
                    type === 'recording'
                        ? 'fa-record-vinyl'
                        : type === 'ready'
                        ? 'fa-check-circle'
                        : 'fa-info-circle'
                statusDiv.innerHTML = `<i class="fas ${icon}"></i> ${message}`
            }

            // 获取摄像头设备列表
            async function getCameraDevices() {
                try {
                    // 先请求摄像头权限以获取设备列表
                    const tempStream =
                        await navigator.mediaDevices.getUserMedia({
                            video: true,
                        })

                    // 获取所有视频设备
                    const allDevices =
                        await navigator.mediaDevices.enumerateDevices()
                    devices = allDevices.filter(
                        (device) => device.kind === 'videoinput'
                    )

                    // 清理临时流
                    tempStream.getTracks().forEach((track) => track.stop())

                    // 更新设备选择列表
                    cameraSelect.innerHTML =
                        '<option value="">选择摄像头...</option>'
                    devices.forEach((device, index) => {
                        const label = device.label || `摄像头 ${index + 1}`
                        cameraSelect.innerHTML += `<option value="${device.deviceId}">${label}</option>`
                    })

                    updateStatus('已检测到摄像头设备', 'ready')
                } catch (error) {
                    console.error('获取设备列表失败:', error)
                    cameraSelect.innerHTML =
                        '<option value="">无法访问摄像头设备</option>'
                }
            }

            // 开启摄像头
            async function startCamera() {
                try {
                    // 获取选择的摄像头和设备配置
                    const deviceId = cameraSelect.value
                    const constraints = {
                        video: {
                            deviceId: deviceId
                                ? { exact: deviceId }
                                : undefined,
                            width: { ideal: 1280 },
                            height: { ideal: 720 },
                        },
                        audio: true, // 同时获取音频
                    }

                    // 根据用户选择调整分辨率
                    switch (resolutionSelect.value) {
                        case 'hd':
                            constraints.video.width = { ideal: 1280 }
                            constraints.video.height = { ideal: 720 }
                            break
                        case 'full-hd':
                            constraints.video.width = { ideal: 1920 }
                            constraints.video.height = { ideal: 1080 }
                            break
                        case '4k':
                            constraints.video.width = { ideal: 3840 }
                            constraints.video.height = { ideal: 2160 }
                            break
                    }

                    // 设置帧率
                    if (frameRateSelect.value !== 'default') {
                        constraints.video.frameRate = {
                            ideal: parseInt(frameRateSelect.value),
                        }
                    }

                    // 请求摄像头访问权限
                    mediaStream = await navigator.mediaDevices.getUserMedia(
                        constraints
                    )

                    // 显示视频流
                    liveVideo.srcObject = mediaStream
                    videoPlaceholder.style.display = 'none'
                    liveVideo.style.display = 'block'

                    // 更新按钮状态
                    startCameraBtn.disabled = true
                    stopCameraBtn.disabled = false
                    startRecordingBtn.disabled = false
                    takeSnapshotBtn.disabled = false

                    updateStatus(
                        '摄像头已开启，点击"开始录制"按钮录制视频',
                        'ready'
                    )

                    // 如果设备列表未加载，现在加载
                    if (devices.length === 0) {
                        getCameraDevices()
                    }
                } catch (error) {
                    console.error('开启摄像头失败:', error)

                    let errorMessage = '无法访问摄像头: '
                    if (error.name === 'NotAllowedError') {
                        errorMessage += '用户拒绝了摄像头权限'
                    } else if (error.name === 'NotFoundError') {
                        errorMessage += '未找到摄像头设备'
                    } else if (error.name === 'NotReadableError') {
                        errorMessage += '摄像头正被其他应用占用'
                    } else {
                        errorMessage += error.message
                    }

                    updateStatus(errorMessage, 'idle')
                }
            }

            // 关闭摄像头
            function stopCamera() {
                if (mediaStream) {
                    // 停止所有轨道
                    mediaStream.getTracks().forEach((track) => track.stop())
                    mediaStream = null

                    // 停止录制（如果正在录制）
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        mediaRecorder.stop()
                    }

                    // 隐藏视频元素
                    liveVideo.srcObject = null
                    liveVideo.style.display = 'none'
                    videoPlaceholder.style.display = 'flex'

                    // 更新按钮状态
                    startCameraBtn.disabled = false
                    stopCameraBtn.disabled = true
                    startRecordingBtn.disabled = true
                    stopRecordingBtn.disabled = true
                    takeSnapshotBtn.disabled = true

                    updateStatus('摄像头已关闭', 'idle')
                }
            }

            // 开始录制
            function startRecording() {
                if (!mediaStream) return

                recordedChunks = []

                // 设置录制格式
                const mimeType = MediaRecorder.isTypeSupported(
                    'video/webm; codecs=vp9'
                )
                    ? 'video/webm; codecs=vp9'
                    : MediaRecorder.isTypeSupported('video/webm')
                    ? 'video/webm'
                    : 'video/mp4'

                // 创建 MediaRecorder 实例
                mediaRecorder = new MediaRecorder(mediaStream, {
                    mimeType: mimeType,
                    videoBitsPerSecond: 2500000, // 2.5 Mbps
                })

                // 收集数据
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data)
                    }
                }

                // 录制完成
                mediaRecorder.onstop = () => {
                    // 创建视频 blob
                    const blob = new Blob(recordedChunks, {
                        type: mediaRecorder.mimeType,
                    })
                    const url = URL.createObjectURL(blob)

                    // 生成时间戳
                    const now = new Date()
                    const timestamp = `${now.getFullYear()}-${(
                        now.getMonth() + 1
                    )
                        .toString()
                        .padStart(2, '0')}-${now
                        .getDate()
                        .toString()
                        .padStart(2, '0')} ${now
                        .getHours()
                        .toString()
                        .padStart(2, '0')}:${now
                        .getMinutes()
                        .toString()
                        .padStart(2, '0')}:${now
                        .getSeconds()
                        .toString()
                        .padStart(2, '0')}`

                    // 添加到录制列表
                    const recordingId = `recording-${Date.now()}`
                    const recordingItem = document.createElement('div')
                    recordingItem.className = 'recording-item'
                    recordingItem.id = recordingId

                    // 视频大小信息
                    const sizeMB = (blob.size / (1024 * 1024)).toFixed(2)

                    recordingItem.innerHTML = `
                    <video controls style="width: 100%; border-radius: 5px; margin-bottom: 10px;">
                        <source src="${url}" type="${mediaRecorder.mimeType}">
                        您的浏览器不支持视频播放
                    </video>
                    <div class="recording-info">
                        <span><i class="fas fa-clock"></i> ${timestamp}</span>
                        <span><i class="fas fa-hdd"></i> ${sizeMB} MB</span>
                    </div>
                    <div class="recording-actions">
                        <button onclick="downloadRecording('${recordingId}')" class="btn" style="background: #38a169; color: white; flex: 1;">
                            <i class="fas fa-download"></i> 下载
                        </button>
                        <button onclick="deleteRecording('${recordingId}')" class="btn" style="background: #f56565; color: white;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `

                    // 添加到列表顶部
                    if (
                        recordingsList.firstChild &&
                        recordingsList.firstChild.style
                    ) {
                        recordingsList.insertBefore(
                            recordingItem,
                            recordingsList.firstChild
                        )
                    } else {
                        recordingsList.innerHTML = ''
                        recordingsList.appendChild(recordingItem)
                    }

                    updateStatus('录制完成，视频已保存到录制列表', 'ready')
                }

                // 开始录制
                mediaRecorder.start()

                // 更新按钮状态
                startRecordingBtn.disabled = true
                stopRecordingBtn.disabled = false

                updateStatus('正在录制视频...', 'recording')
            }

            // 停止录制
            function stopRecording() {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop()

                    // 更新按钮状态
                    startRecordingBtn.disabled = false
                    stopRecordingBtn.disabled = true
                }
            }

            // 拍照
            function takeSnapshot() {
                if (!mediaStream) return

                // 创建 canvas 元素
                const canvas = document.createElement('canvas')
                canvas.width = liveVideo.videoWidth
                canvas.height = liveVideo.videoHeight

                // 绘制当前视频帧
                const ctx = canvas.getContext('2d')
                ctx.drawImage(liveVideo, 0, 0, canvas.width, canvas.height)

                // 创建下载链接
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob)
                    const a = document.createElement('a')
                    a.href = url
                    a.download = `snapshot-${Date.now()}.png`
                    document.body.appendChild(a)
                    a.click()
                    document.body.removeChild(a)
                    URL.revokeObjectURL(url)

                    updateStatus('照片已保存', 'ready')
                }, 'image/png')
            }

            // 下载录制视频
            function downloadRecording(recordingId) {
                const recordingItem = document.getElementById(recordingId)
                if (!recordingItem) return

                const videoElement = recordingItem.querySelector('video')
                const sourceElement = videoElement.querySelector('source')

                if (sourceElement) {
                    const a = document.createElement('a')
                    a.href = sourceElement.src
                    a.download = `recording-${Date.now()}.${
                        sourceElement.type.includes('webm') ? 'webm' : 'mp4'
                    }`
                    document.body.appendChild(a)
                    a.click()
                    document.body.removeChild(a)

                    updateStatus('视频下载中...', 'ready')
                }
            }

            // 删除录制视频
            function deleteRecording(recordingId) {
                const recordingItem = document.getElementById(recordingId)
                if (recordingItem) {
                    // 释放对象 URL
                    const videoElement = recordingItem.querySelector('video')
                    const sourceElement = videoElement.querySelector('source')
                    if (sourceElement && sourceElement.src) {
                        URL.revokeObjectURL(sourceElement.src)
                    }

                    recordingItem.remove()

                    // 如果没有录制内容，显示占位符
                    if (recordingsList.children.length === 0) {
                        recordingsList.innerHTML = `
                        <div class="recording-item" style="text-align: center; padding: 30px;">
                            <i class="fas fa-video fa-2x" style="color: #cbd5e0; margin-bottom: 10px;"></i>
                            <p>录制视频将显示在这里</p>
                        </div>
                    `
                    }

                    updateStatus('视频已删除', 'ready')
                }
            }

            // 事件监听器
            startCameraBtn.addEventListener('click', startCamera)
            stopCameraBtn.addEventListener('click', stopCamera)
            startRecordingBtn.addEventListener('click', startRecording)
            stopRecordingBtn.addEventListener('click', stopRecording)
            takeSnapshotBtn.addEventListener('click', takeSnapshot)

            // 设备变化时重新获取设备列表
            navigator.mediaDevices.addEventListener(
                'devicechange',
                getCameraDevices
            )

            // 页面加载时获取设备列表
            window.addEventListener('load', () => {
                getCameraDevices()
                updateStatus('系统已就绪，点击"开启摄像头"按钮开始', 'idle')
            })

            // 页面卸载时清理资源
            window.addEventListener('beforeunload', () => {
                if (mediaStream) {
                    mediaStream.getTracks().forEach((track) => track.stop())
                }
            })
        </script>
    </body>
</html>
